@Html.Partial("Header")
@{
    Style.Require("Flow");
    HtmlHelper.ClientValidationEnabled = true;
    HtmlHelper.UnobtrusiveJavaScriptEnabled = true;
    Layout.Title = T("Flow Search").ToString();
}
Goto <input type="text" id="location" />
<div id="map-search" style="width: 100%; height: 70vh"></div>
<script type="text/javascript">
    var drawing = false;
    var smap;
    var cmap;
    function initialize() {
        if (drawing)
            smap = SetupDrawingMap('map-search');
        else
            smap = SetupMap('map-search');
        RedrawMap(smap);
        
    }
   
    $(document).ready(function () {
        if (!drawing)
            LoadScript('https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&callback=initialize');
        else
            LoadScript('http://maps.googleapis.com/maps/api/js?libraries=drawing&sensor=true&callback=initialize');
        LoadScript('@Url.Content("~/Modules/NKD/Scripts/NKD.maps.js")');
    });

    function OnMapUpdate(map, event, center, viewport) {
        cmap = map;
        console.log(event, viewport)        
        if (event.eventType == "EDITED") {
            if (event.eventSource.type == "marker") {
                DeleteExceptedShape(map, event.eventSource)
            }
            else {
                DeleteExceptedShapeTypes(map);
            }
        }
    }

    var x;

    $("#location").autocomplete({
        delay: 100,
        source: function (request, response) {
            $.ajax({
                url: "/share/getlocations/" + request.term,
                type: "GET",
                dataType: "json",
                //data: { id: request.term },
                success: function (data) {
                    response($.map(data, function (item) {
                        return {
                            label: item.Text, value: item.Text, id: item.Value
                        }
                    }))
                }
            })
        },
        focus: function (event, ui) {
            AddGeographyUnique(smap, JSON.parse(ui.item.id).spatial, false, ui.item.label, true, NewGUID());
            RefocusMap(smap);
            smap.setZoom(9);
        },
        response: function (event, ui) {
            if (ui.content.length > 0) {
                AddGeographyUnique(smap, JSON.parse(ui.content[0].id).spatial, false, ui.content[0].label, true, NewGUID());
                RefocusMap(smap);
                smap.setZoom(9);
            }
            else {
                GetAddressLocation($("#location").val(), function (latlng) {
                    DeleteShapes(smap);
                    AddMarkerSingle(smap, latlng, false, $("#location").val(), NewGUID());
                    RefocusMap(smap);
                    smap.setZoom(15);
                });
            }

        }
    });

</script>